<layout name='Layout/wbs_home' />
<script type="text/javascript">
    function zTreeOnClick(event, treeId, treeNode) {
        var wt = treeNode.wbs_type;
        //alert("wbs_type="+wt);
    };

    function setFontCss(treeId, treeNode) {
        return treeNode.node_type == "pbs" ? {color:"Gray"} : {color: "Black"};
    };

    // 控制节点图标是否显示
    function showIconForTree(treeId, treeNode) {
        return treeNode.node_type == "wbs";
    };

    var setting = {
        callback: {onClick: zTreeOnClick},
        view: {
            //fontCss: setFontCss
            showIcon: showIconForTree
            //nameIsHTML: true
        }
    };

    var nodes = {$node_json|default="[空节点]"};

    $(document).ready(function(){
        $.fn.zTree.init($("#wbs_tree"), setting, nodes);

        $(document).on("click", ".inputbox .address_list a.del", function () {
            $(this).parent().parent().remove();
        });
    });

    function select_auth() {
        winopen("{:U('popup/auth')}", 730, 574);
    }

</script>

<input type="hidden" name="ajax" id="ajax" value="0">
<!--
{:W('PageHeader',array('name'=>$folder_name,'search'=>'N'))}
-->
<!--
<div class="operate panel panel-default">
    <div class="panel-body">
        <div class="pull-right">
            <a onclick="add()" class="btn btn-sm btn-primary">新增</a>
            <a onclick="save()" class="btn btn-sm btn-primary">保存</a>
            |
            <a onclick="del()" class="btn btn-sm btn-danger">删除</a>
        </div>
    </div>
</div>
-->
<div class="row">
    <div class="col-xs-12 col-sm-6">

        <div>
            <!--节点树顶部标题与导航-->
            <div class="widget-header">
                <h4>WBS节点树</h4>
                <div class="widget-toolbar">
                    <a href="#" class="">
                        <i class="fa fa-plus-square purple"></i>
                        导入节点
                    </a>
                </div>

            </div>
            <div class="widget-body">
                <div class="widget-main">
                    <div class="row">
                        <!--节点树容器-->
                        <div class="col-xs-12 col-sm-6">
                            <present name="node_json">
                                <ul id="wbs_tree" class="ztree"></ul>
                            </present>
                        </div>

                        <!--节点树操作区-->
                        <div class="col-xs-12 col-sm-6">
                            <div class="operate panel panel-default">
                                <div class="panel-body">
                                    <button class="btn btn-primary btn-sm">
                                        <i class="fa fa-edit bigger-110"></i>
                                        新增
                                    </button>
                                    <button class="btn btn-primary btn-sm">
                                        <i class="fa fa-cogs bigger-100"></i>
                                        编辑
                                    </button>
                                </div>
                            </div>

                            <!--临时测试-->
                            <ul class="list-unstyled">
                                <li style="list-style: none;">
                                    <i class="fa fa-bell purple" aria-hidden="true"></i>
                                    暂无通知
                                </li>

                                <li>
                                    <i class="fa fa-check green"></i>
                                    进度管理对象已初始化
                                </li>

                                <li>
                                    <i class="fa fa-clock-o red"></i>
                                    任务计划开始时间
                                    <!--bootstrap日期控件测试-->
                                    <div class="row">
                                        <div class="col-xs-12 col-sm-6">

                                            <div class="input-group">
                                                <input class="form-control date-picker" id="id-date-picker-1" type="text" data-date-format="yyyy-mm-dd" />
                                            <span class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </span>
                                            </div>
                                        </div>
                                    </div>
                                </li>
                            </ul>



                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <!--WBS编辑区-->
    <div class="col-xs-12 col-sm-6">

        <!-- 新增WBS模块的容器 -->
        <form id="form_data" name="form_data" method="post" post_url="{:U('wbs/add')}" class="form-horizontal clearfix" enctype="multipart/form-data">
            <div class="tabbable" id="wbs_add_node">
                <!--- 顶部标签页-->
                <ul class="nav nav-tabs" id="wbs_add_node_tab">
                    <li class="active">
                        <a data-toggle="tab" href="#new_wbs_basic">
                            <i class="green fa fa-home bigger-100"></i>
                            基本信息
                        </a>
                    </li>

                    <li class="">
                        <a data-toggle="tab" href="#new_wbs_agent">
                            <i class="blue fa fa-server bigger-50"></i>
                            任务明细
                            <!--  消息条数用法示例
                            <span class="badge badge-danger">4</span>
                            -->
                        </a>
                    </li>

                    <li class="">
                        <a data-toggle="tab" href="#new_wbs_progress">
                            <i class="red fa fa-calendar bigger-50"></i>
                            进度管理
                            <!--  消息条数用法示例
                            <span class="badge badge-danger">4</span>
                            -->
                        </a>
                    </li>

                    <!-- 下拉列表型tab用法示例
                    <li class="dropdown">
                        <a data-toggle="dropdown" class="dropdown-toggle" href="#">
                            Dropdown &nbsp;
                            <i class="icon-caret-down bigger-110 width-auto"></i>
                        </a>

                        <ul class="dropdown-menu dropdown-info">
                            <li>
                                <a data-toggle="tab" href="#dropdown1">@fat</a>
                            </li>

                            <li>
                                <a data-toggle="tab" href="#dropdown2">@mdo</a>
                            </li>
                        </ul>
                    </li>
                    -->
                </ul>

                <!--新增模块表单内容, 分三块-->
                <div class="tab-content">

                    <!--新增WBS基本信息-->
                    <div id="new_wbs_basic" class="tab-pane active">

                        <input type="hidden" name="project_id" id="project_id" value="{$Think.session.proj_id}">
                        <input type="hidden" name="pbs_id" id="pbs_id" value="">
                        <input type="hidden" name="parent_id" id="parent_id" value="">

                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="name">名称* </label>
                            <div class="col-sm-9">
                                <input class="form-control" type="text" id="name" name="name" check="require" msg="请输入WBS名称">
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="type">WBS类型* </label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <select id="type" name="type" form="form_data">
                                        <volist name="type_list" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="depart">分工部门* </label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <select id="depart" name="depart" form="form_data">
                                        <volist name="depart_list" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="engineering_phase">工程阶段* </label>
                            <div class="col-sm-9">
                                <div class="input-group">
                                    <select id="engineering_phase" name="engineering_phase" form="form_data">
                                        <volist name="engineering_phase" id="vo">
                                            <option value="{$vo.id}">{$vo.name}</option>
                                        </volist>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="remark" >备注*</label>
                            <div class="col-sm-10" >
                                <textarea class="form-control" name="remark" id="remark" rows="5" class="col-xs-12" ></textarea>
                            </div>
                        </div>

                        <!--文件上传组件-->
                        <div class="widget-box">
                            <div class="widget-header">
                                <h4>说明文件上传</h4>
                            </div>

                            <div class="widget-body">
                                <div class="widget-main">
                                    <!--<input type="file" id="id-input-file-2" />-->
                                    <input multiple="" type="file" id="input-file" name="input-file[]" />
                                    <label>
                                        <input type="checkbox" name="file-format" id="id-file-format" class="ace" />
                                        <span class="lbl"> 仅允许图片</span>
                                    </label>
                                </div>
                            </div>
                        </div>

                    </div>

                    <!--新增WBS明细(agent)编辑-->
                    <div id="new_wbs_agent" class="tab-pane">
                        <div class="form-group">
                            <label class="col-sm-2 control-label" for="folder_name">负责人：</label>
                            <div class="col-sm-6">
                                <div id="admin_list" class="inputbox">
                                    <a class="pull-right btn btn-link text-center" onclick="select_auth();"> <i class="fa fa-user"></i> </a>
                                    <div class="wrap" >
                                        <span class="address_list"></span>
							<span class="text" >
								<input class="letter" type="text"  >
							</span>
                                    </div>
                                    <div class="search dropdown ">
                                        <ul class="dropdown-menu"></ul>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="new_wbs_progress" class="tab-pane">
                        WBS进度管理单元
                    </div>

                </div>

                <!--新增WBS提交操作区-->
                <div class="clearfix form-actions">
                    <div class="pull-right">
                        <!--<a onclick="add()" class="btn btn-sm btn-primary">新增</a>-->
                        <a onclick="add()" class="btn btn-sm btn-primary">添加</a>
                        |
                        <a onclick="clear()" class="btn btn-sm btn-danger">清空</a>
                    </div>
                </div>


            </div>


        </form>


    </div>
</div>


<include file="Layout:aeropms_footer" />

<!-- inline scripts related to this page -->

<script>
    $('.date-picker').datepicker({
        autoclose: true,
        todayHighlight: true
    }).next().click(function(){
        $(this).prev().focus();
    });

    /*文件上传组件*/
    jQuery(function($){

/*        $('#id-input-file-1 , #id-input-file-2').ace_file_input({
            no_file:'没有选择文件 ...',
            btn_choose:'选择文件',
            btn_change:'重新选择',
            droppable:false,
            onchange:null,
            thumbnail:false //| true | large
            //whitelist:'gif|png|jpg|jpeg'
            //blacklist:'exe|php'
            //onchange:''
            //
        });*/

        $('#input-file').ace_file_input({
            style:'well',
            btn_choose:'点击选择文件或将文件拖放至该区域',
            btn_change:null,
            no_icon:'fa fa-cloud-upload',
            droppable:true,
            thumbnail:'small'//large | fit
            //,icon_remove:null//set null, to hide remove/reset button
            /**,before_change:function(files, dropped) {
						//Check an example below
						//or examples/file-upload.html
						return true;
					}*/
            /**,before_remove : function() {
						return true;
					}*/
            ,
            preview_error : function(filename, error_code) {
                //name of the file that failed
                //error_code values
                //1 = 'FILE_LOAD_FAILED',
                //2 = 'IMAGE_LOAD_FAILED',
                //3 = 'THUMBNAIL_FAILED'
                //alert(error_code);
            }

        }).on('change', function(){
            //console.log($(this).data('ace_input_files'));
            //console.log($(this).data('ace_input_method'));
        });


        //dynamically change allowed formats by changing before_change callback function
        $('#id-file-format').removeAttr('checked').on('change', function() {
            var before_change
            var btn_choose
            var no_icon
            if(this.checked) {
                btn_choose = "点击选择图片或将图片拖放至该区域";
                no_icon = "fa fa-image";
                before_change = function(files, dropped) {
                    var allowed_files = [];
                    for(var i = 0 ; i < files.length; i++) {
                        var file = files[i];
                        if(typeof file === "string") {
                            //IE8 and browsers that don't support File Object
                            if(! (/\.(jpe?g|png|gif|bmp)$/i).test(file) ) return false;
                        }
                        else {
                            var type = $.trim(file.type);
                            if( ( type.length > 0 && ! (/^image\/(jpe?g|png|gif|bmp)$/i).test(type) )
                                    || ( type.length == 0 && ! (/\.(jpe?g|png|gif|bmp)$/i).test(file.name) )//for android's default browser which gives an empty string for file.type
                                    ) continue;//not an image so don't keep this file
                        }

                        allowed_files.push(file);
                    }
                    if(allowed_files.length == 0) return false;

                    return allowed_files;
                }
            }
            else {
                btn_choose = "点击选择文件或将文件拖放至该区域";
                no_icon = "fa fa-cloud-upload";
                before_change = function(files, dropped) {
                    return files;
                }
            }
            var file_input = $('#input-file');
            file_input.ace_file_input('update_settings', {'before_change':before_change, 'btn_choose': btn_choose, 'no_icon':no_icon})
            file_input.ace_file_input('reset_input');
        });

    });

</script>