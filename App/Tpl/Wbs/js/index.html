<script type="text/javascript">
    /**
     * 根据工程阶段过滤wbs节点树显示
     * */
    function eng_phase_filter(o){
        op = $(o).val();
        //使用ztree方法进行前端过滤
        var tree = $.fn.zTree.getZTreeObj("wbs_tree");
        var nodes = tree.getNodesByParam('isHidden', true);
        tree.showNodes(nodes);
        if(op == -1){
            return;
        }
        var nodes = tree.getNodesByFilter(function(node){
            return node["parent_id"]!='-1' && node["engineering_phase"] != op && node["is_hideable"] == '1';
        });
        console.log("nodes to hide: " + nodes.length);
        tree.hideNodes(nodes);
    }

    //设置wbs输入项
    function set_wbs_input(){
        var tree = $.fn.zTree.getZTreeObj("id_wbs_input_tree");
        var treeNode = tree.getSelectedNodes()[0];
        var html = conv_inputbox_item(treeNode.id, treeNode.name, treeNode.wbs_type, treeNode.pbs_id);
        $("#id_wbs_input_list .address_list", parent.document).append(html);
    }
    //读取wbs节点, 以ajax方法
    function get_wbs_input(){
        var settings = { };
        var wbs = jQuery.getJSON( '{:U("wbs/read", "proj_id=$proj_id")}', function(data){
            $.fn.zTree.init($("#id_wbs_input_tree"), settings, data);
        } );
    };

    //模态对话框
    $('#modal-form').on('shown.bs.modal', function () {
        get_wbs_input();
    });
//    $('#modal-form').on('shown', function () {
//        get_wbs();
//    })


    var wbs_field_name = {
        'name':'单元名称',
        'node_type':'节点单元类型',
        'type_name':'WBS单元类型',
        'epname':'工程阶段',
        'dep_name':'分工部门',
        'remark':'描述',
        'create_time':'创建时间',
        'update_time':'更新时间'
    };

    var wbs_type_enum = [
            <volist name="type_list" id="vo">
            { 'key': '{$vo.id}', 'val':'{$vo.name}'},
    </volist>];
    //ztree节点回调函数
    function zTreeOnClick(event, treeId, treeNode) {
        var wt = treeNode.wbs_type;
        $("#type").html("");
        for(var i = (wt<=0?1:wt); i <= 3; i++){
            $("#type").append( $("<option></option>", {'value':wbs_type_enum[i-1].key}).html(wbs_type_enum[i-1].val) );
        }
        /*if(wt >= 3)
            $("#id_tab_add_wbs").attr('data-toggle', null).parent().addClass('disabled');
        else
            $("#id_tab_add_wbs").attr('data-toggle', 'tab').parent().removeClass('disabled');*/
        //以ajax方式读取单个节点数据
        var url =  '{:U("wbs/read", "proj_id=$proj_id")}' + '&node_id=' + treeNode.id + '&type=' + treeNode.node_type;
        //console.log("Query URL: " + url);
        var wbs = jQuery.getJSON(url, function(data){
            //解析返回的JSON
            console.log(JSON.stringify(data));
            var elem = $("#id_wbs_basic_info").html("");
            for(item in data){
                //console.log(item);
                $("<div></div>", {'class':'profile-info-row'})
                        .append($("<div></div>", {'class':'profile-info-name'}).text(wbs_field_name[item]))
                        .append($("<div></div>", {'class':'profile-info-value'}).text(data[item]))
                        .appendTo(elem);
            }
        });
    };

    //控制节点字体
    function setFontCss(treeId, treeNode) {
        return treeNode.node_type == "pbs" ? {color:"Gray"} : {color: "Black"};
    };

    // 控制节点图标是否显示
    function showIconForTree(treeId, treeNode) {
        return treeNode.node_type == "wbs";
    };

    var setting = {
        callback: {onClick: zTreeOnClick},
        view: {
            //fontCss: setFontCss
            showIcon: showIconForTree
            //nameIsHTML: true
        }
    };

    var nodes = {$node_json|default="[空节点]"};

    //WBS输入选择树的配置
    var wbsi_setting = {};

    $(document).ready(function(){
        var total_tree = $.fn.zTree.init($("#wbs_tree"), setting, nodes);

        //为团队人员选择结果列表添加删除按钮事件
        $(document).on("click", ".inputbox .address_list a.del", function () {
            $(this).parent().parent().remove();
        });
    });

    //WBS团队成员选择弹出框
    function select_team(is_leader, o) {
        var container = $(o).parent().attr("id");
        var url = "{:U('popup/wbsteam', 'container=')}"+container
        if(is_leader){
            url += "&is_leader=1";
        }
        console.log(url);
        winopen(url, 730, 574);
    };

    // 新增WBS节点按钮事件
    function add_wbs()
    {
        //event.preventDefault();
        // 构造节点路径
        var tree = $.fn.zTree.getZTreeObj("wbs_tree");
        var sn = tree.getSelectedNodes()[0];
        if(!sn)
        {
            ui_error("未选择任何WBS或PBS节点作为父节点, 请重新选择.");
            return false;
        }
        //alert("parent id = " + sn.id);
        //根据节点的node_type选择父节点
        switch(sn.node_type){
            case "pbs": var pid = tree.getNodeByParam("wbs_parent", -1, null);
                if(!pid){
                    ui_error("无法定位WBS根节点, 请检查数据.");
                    return;
                }
                $("#parent_id").val(pid.id);
                $("#pbs_id").val(sn.id);
                break;
            case "wbs": $("#parent_id").val(sn.id);
                $("#pbs_id").val(sn.pbs_id);
                break;
            default: ui_error("未选择任何WBS或PBS节点作为父节点, 请重新选择.");
                return;
        }

        /*将输出列表组装为json*/
        var wbs_output_json = $("#id_wbs_output_list li").map(function(){
            if($(this).text().length > 1)
                return {"type": $(this).attr('data-output-type'), "name": $(this).text()};
                //return '{ "type": "' + $(this).attr('data-output-type') + '", "name": "' + $(this).text() + '" }';
        }).get();
        if(wbs_output_json.length > 0){
            $("#wbs_output_list").val(JSON.stringify(wbs_output_json));
        }

        //将输入列表组装为json
        var wbs_input_json = $("#id_wbs_input_list .address_list span").map(function(){
            if($(this).text().length > 1)
                return {"wbs_id": $(this).attr('id')}
                //return '{ "wbs_id": "' + $(this).attr('id') + '" }';
        //}).get().join();
        }).get();
        //$("#wbs_input_list").val( '[' + wbs_input_json + ']' );
        if(wbs_input_json.length > 0) {
            $("#wbs_input_list").val(JSON.stringify(wbs_input_json));
            console.log($("#wbs_input_list").val());
        }


        //将负责人列表组装为json
        var team_leader_json = $("#id_admin_list .address_list span").map(function(){
            if($(this).text().length > 1)
                return {"leader_id": $(this).attr('id')}
        }).get();
        $("#team_leader_list").val( JSON.stringify(team_leader_json) );
        console.log($("#team_leader_list").val());

        //将成员列表组装为json
        var team_member_json = $("#id_member_list .address_list span").map(function(){
            if($(this).text().length > 1)
                return {"member_id": $(this).attr('id')}
        }).get();
        $("#team_member_list").val( JSON.stringify(team_member_json) );
        console.log($("#team_member_list").val());

        url = $("#form_data").attr("post_url");
        if(check_form("form_data")){
            sendForm("form_data", url);
        }


    };

    /*任务输出列表操作*/
    var wbs_output_list_style = {
        '1': "fa fa-image green",
        '2': "fa fa-file-word-o blue",
        '3': "fa fa-file-archive-o red",
        '4': "fa fa-file purple"
    };
    function remove_wbs_output(obj){
        $(obj).parent().remove();
    };

    function add_output(){
        var wbt = $("#wbs_output_type").val();
        //var wbs_output_type_name = $("#wbs_output_type option:selected").text();
        var wbs_output_name = $("#wbs_output_name").val();
        //alert(wbs_output_type_name + ',' + wbs_output_name);
        $("<li></li>").attr("data-output-type", wbt)
                .html("<i class='" + wbs_output_list_style[wbt] + "' aria-hidden='true'></i>" + wbs_output_name)
                .append("<a href='#' onclick='remove_wbs_output(this)' class='pull-right'><i class='fa fa-times red' aria-hidden='true'></i></a>")
                .appendTo("#id_wbs_output_list");
    };

    /*日期选择组件*/
    $('.date-picker').datepicker({
        autoclose: true,
        todayHighlight: true
    }).next().click(function(){
        $(this).prev().focus();
    });

    /*文件上传组件*/
    jQuery(function($){

        /*        $('#id-input-file-1 , #id-input-file-2').ace_file_input({
         no_file:'没有选择文件 ...',
         btn_choose:'选择文件',
         btn_change:'重新选择',
         droppable:false,
         onchange:null,
         thumbnail:false //| true | large
         //whitelist:'gif|png|jpg|jpeg'
         //blacklist:'exe|php'
         //onchange:''
         //
         });*/


        $('#input-file').ace_file_input({
            style:'well',
            btn_choose:'点击选择文件或将文件拖放至该区域',
            btn_change:null,
            no_icon:'fa fa-cloud-upload',
            droppable:true,
            thumbnail:'small'//large | fit
            //,icon_remove:null//set null, to hide remove/reset button
            /**,before_change:function(files, dropped) {
						//Check an example below
						//or examples/file-upload.html
						return true;
					}*/
            /**,before_remove : function() {
						return true;
					}*/
            ,
            preview_error : function(filename, error_code) {
                //name of the file that failed
                //error_code values
                //1 = 'FILE_LOAD_FAILED',
                //2 = 'IMAGE_LOAD_FAILED',
                //3 = 'THUMBNAIL_FAILED'
                //alert(error_code);
            }

        }).on('change', function(){
            //console.log($(this).data('ace_input_files'));
            //console.log($(this).data('ace_input_method'));
        });


        //dynamically change allowed formats by changing before_change callback function
        $('#id-file-format').removeAttr('checked').on('change', function() {
            var before_change
            var btn_choose
            var no_icon
            if(this.checked) {
                btn_choose = "点击选择图片或将图片拖放至该区域";
                no_icon = "fa fa-image";
                before_change = function(files, dropped) {
                    var allowed_files = [];
                    for(var i = 0 ; i < files.length; i++) {
                        var file = files[i];
                        if(typeof file === "string") {
                            //IE8 and browsers that don't support File Object
                            if(! (/\.(jpe?g|png|gif|bmp)$/i).test(file) ) return false;
                        }
                        else {
                            var type = $.trim(file.type);
                            if( ( type.length > 0 && ! (/^image\/(jpe?g|png|gif|bmp)$/i).test(type) )
                                    || ( type.length == 0 && ! (/\.(jpe?g|png|gif|bmp)$/i).test(file.name) )//for android's default browser which gives an empty string for file.type
                            ) continue;//not an image so don't keep this file
                        }

                        allowed_files.push(file);
                    }
                    if(allowed_files.length == 0) return false;

                    return allowed_files;
                }
            }
            else {
                btn_choose = "点击选择文件或将文件拖放至该区域";
                no_icon = "fa fa-cloud-upload";
                before_change = function(files, dropped) {
                    return files;
                }
            }
            var file_input = $('#input-file');
            file_input.ace_file_input('update_settings', {'before_change':before_change, 'btn_choose': btn_choose, 'no_icon':no_icon})
            file_input.ace_file_input('reset_input');
        });

    });

</script>