<script type="text/javascript">
    /**
     * --------------------------------------------
     * 常量定义
     * --------------------------------------------
     */
    var wbs_field_name = {
        'name':'单元名称',
        'node_type':'节点单元类型',
        'type_name':'WBS单元类型',
        'epname':'工程阶段',
        'dep_name':'分工部门',
        'remark':'描述',
        'create_time':'创建时间',
        'update_time':'更新时间'
    };

    var wbs_type_enum = [
        <volist name="type_list" id="vo">
        { 'key': '{$vo.id}', 'val':'{$vo.name}'},
        </volist>
    ];

    /*WBS输出项列表样式*/
    var wbs_output_list_style = {
        '1': "fa fa-image green",
        '2': "fa fa-file-word-o blue",
        '3': "fa fa-file-archive-o red",
        '4': "fa fa-file purple"
    };

    //WBS节点信息全局对象, 用于WBS信息展示和编辑
    var g_wbs_node_info= {};

    /**
     * ------------------------------------------------
     * WBS核心逻辑代码段
     * ------------------------------------------------
     * */

    // 根据工程阶段选项过滤主节点树
    function eng_phase_filter(o){
        op = $(o).val();
        //使用ztree方法进行前端过滤
        var tree = $.fn.zTree.getZTreeObj("wbs_tree");
        var nodes = tree.getNodesByParam('isHidden', true);
        tree.showNodes(nodes);
        if(op == -1){
            return;
        }
        var nodes = tree.getNodesByFilter(function(node){
            return node["parent_id"]!='-1' && node["engineering_phase"] != op && node["is_hideable"] == '1';
        });
        //console.log("nodes to hide: " + nodes.length);
        tree.hideNodes(nodes);
    }

    //模态对话框中点击确定后, 设置wbs输入项
    function set_wbs_input(){
        var tree = $.fn.zTree.getZTreeObj("id_wbs_input_tree");
        var treeNode = tree.getSelectedNodes()[0];
        var html = conv_inputbox_item(treeNode.id, treeNode.name, treeNode.wbs_type, treeNode.pbs_id);
        $("#id_wbs_input_list .address_list", parent.document).append(html);
    }

    //模态对话框中点击确定后, 设置pbs依赖项
    function set_pbs_depend(){
        var tree = $.fn.zTree.getZTreeObj("id_pbs_depend_tree");
        var treeNode = tree.getSelectedNodes()[0];
        var html = conv_inputbox_item(treeNode.id, treeNode.name, treeNode.wbs_type, treeNode.pbs_id);
        $("#id_pbs_depend_list .address_list", parent.document).html(html);
        $("#pbs_id").val(treeNode.id);
    }

    //以ajax方法读取树节点, 用于模态对话框中
    function read_tree(url, selector){
        var settings = { };
        var wbs = jQuery.getJSON(url, function(data){
            $.fn.zTree.init($(selector), settings, data);
        } );
    };

    //wbs输入的模态对话框
    $('#id_modal_wbs_input').on('shown.bs.modal', function () {
        read_tree('{:U("wbs/read", "proj_id=$proj_id")}', "#id_wbs_input_tree");
    });
//    $('#modal-form').on('shown', function () {
//        get_wbs();
//    })

    // pbs依赖输入的模态对话框
    $('#id_modal_pbs_depend').on('shown.bs.modal', function () {
        read_tree('{:U("pbs/read", "proj_id=$proj_id")}', "#id_pbs_depend_tree");
    });

    //WBS团队成员选择弹出框
    function select_team(is_leader, o) {
        var container = $(o).parent().attr("id");
        var url = "{:U('popup/wbsteam', 'container=')}"+container
        if(is_leader){
            url += "&is_leader=1";
        }
        winopen(url, 730, 574);
    };

    // 移除WBS输出列表项
    function remove_wbs_output(obj){
        $(obj).parent().remove();
    };

    // 添加WBS输出列表项
    function add_output(){
        var wbt = $("#wbs_output_type").val();
        //var wbs_output_type_name = $("#wbs_output_type option:selected").text();
        var wbs_output_name = $("#wbs_output_name").val();
        //alert(wbs_output_type_name + ',' + wbs_output_name);
        $("<li></li>").attr("data-output-type", wbt)
                .html("<i class='" + wbs_output_list_style[wbt] + "' aria-hidden='true'></i>" + wbs_output_name)
                .append("<a href='#' onclick='remove_wbs_output(this)' class='pull-right'><i class='fa fa-times red' aria-hidden='true'></i></a>")
                .appendTo("#id_wbs_output_list");
    };

    //计算两个日期之间的有效工作日
    function check_date(d1, d2)
    {
        var elapsed = (d2 - d1)/3600000/24;
        console.log(elapsed);
        if(elapsed < 0){
            ui_error("选择的计划起止时间无效, 请重新选择!");
            return;
        }
        //日期差值,即包含周六日、以天为单位的工时，86400000=1000*60*60*24.
        var workDayVal = (d2 - d1)/86400000 + 1;
        //工时的余数
        var remainder = workDayVal % 7;
        //工时向下取整的除数
        var divisor = Math.floor(workDayVal / 7);
        var weekendDay = 2 * divisor;
        //起始日期的星期，星期取值有（1,2,3,4,5,6,0）
        var nextDay = d1.getDay();
        //从起始日期的星期开始 遍历remainder天
        for(var tempDay = remainder; tempDay>=1; tempDay--) {
            //第一天不用加1
            if(tempDay == remainder) {
                nextDay = nextDay + 0;
            } else if(tempDay != remainder) {
                nextDay = nextDay + 1;
            }
            //周日，变更为0
            if(nextDay == 7) {
                nextDay = 0;
            }

            //周六日
            if(nextDay == 0 || nextDay == 6) {
                weekendDay = weekendDay + 1;
            }
        }
        //实际工时（天） = 起止日期差 - 周六日数目。
        workDayVal -= weekendDay;
        $("#id_working_day_spinner").val(workDayVal);
        calc_working_hour();
    }

    //计算工时并显示于页面dom
    function calc_working_hour()
    {
        var hours = $("#id_working_day_spinner").val() * $("#id_working_hour_spinner").val();
        $("#id_working_hour_count").text("计划工时合计: " + hours);
    }

    /**
     * 各模块的序列化方法
     */
    function serialize_wbs_output(selector){
        var wbs_output_json = dom_map("#id_wbs_output_list li", function(){
            if($(this).text().length > 1)
                return {"type": $(this).attr('data-output-type'), "item_name": $(this).text()};
        });
        if(wbs_output_json.length > 0){
            $(selector).val(JSON.stringify(wbs_output_json));
            console.log("Wbs output: " + $(selector).val());
        }
        else{$(selector).val("");}
    }

    function serialize_wbs_input(selector){
        var wbs_input_json = dom_map("#id_wbs_input_list .address_list span", function(){
            return {"input_node_id": $(this).attr('id')};
        });
        if(wbs_input_json.length > 0) {
            $(selector).val(JSON.stringify(wbs_input_json));
            console.log("Wbs input: " + $(selector).val());
        }
        else{$(selector).val("");}
    }

    function serialize_team_list(src_selector, dst_selector){
        var team_leader_json = dom_map(src_selector + " .address_list span", function(){
            if($(this).text().length > 1)
                return {"id": $(this).attr('id')}
        });
        if(team_leader_json.length > 0){
            $(dst_selector).val( JSON.stringify(team_leader_json[0] ) );
            console.log(src_selector + " team list: " + $(dst_selector).val());
        }
        else{$(dst_selector).val("");}
    }

    function serialize_schedule(selector){
        if($("#id_date_picker_start").val() && $("#id_date_picker_end").val())
        {
            var planning_schedule = {
                "planning_begin_time": $("#id_date_picker_start").val(),
                "planning_end_time": $("#id_date_picker_end").val(),
                "planning_working_day": $("#id_working_day_spinner").val(),
                "planning_working_hour": $("#id_working_hour_spinner").val()
            };
            $(selector).val(JSON.stringify(planning_schedule));
            console.log("Planning schedule: " + $(selector).val());
        }
        else{$(selector).val("");}
    }

    // 新增WBS节点方法
    function add_wbs()
    {
        //event.preventDefault();
        // 构造节点路径
        var tree = $.fn.zTree.getZTreeObj("wbs_tree");
        var sn = tree.getSelectedNodes()[0];
        if(!sn)
        {
            ui_error("未选择任何WBS或PBS节点作为父节点, 请重新选择.");
            return false;
        }
        //根据节点的node_type选择父节点
        switch(sn.node_type){
            case "pbs": var pid = tree.getNodeByParam("wbs_parent", -1, null);
                if(!pid){
                    ui_error("无法定位WBS根节点, 请检查数据.");
                    return;
                }
                $("#parent_id").val(pid.id);
                $("#pbs_id").val(sn.id);
                break;
            case "wbs": $("#parent_id").val(sn.id);
                break;
            default: ui_error("未选择任何WBS节点作为父节点, 请在WBS节点树上重新选择.");
                return;
        }

        var url = $("#form_data").attr("post_url");
        if(check_form("form_data")){
            /*将输出列表组装为json*/
            serialize_wbs_output("#wbs_output_list");

            /*将输入列表组装为json*/
            serialize_wbs_input("#wbs_input_list");

            // 将负责人列表组装为json
            serialize_team_list("#id_admin_list", "#team_leader_list");
            serialize_team_list("#id_member_list", "#team_member_list");

            //将schedule组装为json
            serialize_schedule("#planning_schedule");

            // 提交
            sendForm("form_data", url);
        }
    };

    // 删除WBS节点
    function del_wbs()
    {
        var tree = $.fn.zTree.getZTreeObj("wbs_tree");
        var sn = tree.getSelectedNodes()[0];
        if(!sn)
        {
            ui_error("未选择任何WBS节点, 请重新选择.");
            return false;
        }
        $("#wbs_edit_type").val("del");
        $("#del_id").val(sn.id);
        console.log("del_id: "+ $("#del_id").val());
        $("#form_edit").attr("action", "{:U('wbs/del')}").submit();
    }

    // 节点内容加载方法
    function load_content(node_id, node_type){
        //以ajax方式读取单个节点数据
        var url =  '{:U("wbs/read", "proj_id=$proj_id")}' + '&node_id=' + node_id + '&type=' + node_type;
        //console.log("Query URL: " + url);
        var wbs = jQuery.getJSON(url, function(data){
            //保存至全局对象
            g_wbs_node_info = data;
            console.log(JSON.stringify(data));

            //根据给定格式构造dom元素显示数据
            var elem = $("#id_wbs_basic_info").html("");
            for(item in g_wbs_node_info["basic"]){
                //console.log(item);
                $("<div></div>", {'class':'profile-info-row'})
                        .append($("<div></div>", {'class':'profile-info-name'}).text(wbs_field_name[item]))
                        .append($("<div></div>", {'class':'profile-info-value'}).text(g_wbs_node_info["basic"][item]))
                        .appendTo(elem);
            }
            //若"编辑节点"标签已激活, 则加载内容至编辑区
            var pnode = $("#id_tab_edit_wbs").parent();
            if(pnode.hasClass("active")){
                load_node_to_edit();
            }
        });
    }

    // 将WBS节点内容读取至编辑区
    function load_node_to_edit()
    {
        $("#id_panel_wbs_edit").show();
        $("#id_panel_wbs_add").hide();

        if($.isEmptyObject(g_wbs_node_info)){
            return;
        }

        //将内容加载至dom
        if(g_wbs_node_info["basic"]){
            var basic = g_wbs_node_info["basic"];
            for(var key in basic){
                console.log("now loading: "+key+",value="+basic[key]);
                set_val(key, basic[key]);
            }
        }
    }

    /**
     * -------------------------------------------------------------
     * ZTree 相关代码段
     * -------------------------------------------------------------
    */
    //ztree节点回调函数
    function zTreeOnClick(event, treeId, treeNode) {
        // 设置WBS类型下拉框
        var wt = treeNode.wbs_type;
        $("#type").html("");
        for(var i = (wt<=0?1:wt); i <= 3; i++){
            $("#type").append(
                    $("<option></option>",
                            {'value':wbs_type_enum[i-1].key}
                    ).html(wbs_type_enum[i-1].val)
            );
        }
        load_content(treeNode.id, treeNode.node_type);
    };

    //控制节点字体
    function setFontCss(treeId, treeNode) {
        return treeNode.node_type == "pbs" ? {color:"Gray"} : {color: "Black"};
    };

    // 控制节点图标是否显示
    function showIconForTree(treeId, treeNode) {
        return treeNode.node_type == "wbs";
    };

    var setting = {
        callback: {onClick: zTreeOnClick},
        view: {
            //fontCss: setFontCss
            showIcon: showIconForTree
            //nameIsHTML: true
        }
    };

    //树节点数据
    var nodes = {$node_json|default="[空节点]"};

    //WBS输入选择树的配置
    var wbsi_setting = {};


    /**
     * --------------------------------------------------------------------
     * 页面加载函数
     * --------------------------------------------------------------------
     * */
    $(document).ready(function(){
        // 初始化主WBS树
        var total_tree = $.fn.zTree.init($("#wbs_tree"), setting, nodes);

        //为团队人员选择结果列表添加删除按钮事件
        $(document).on("click", ".inputbox .address_list a.del", function () {
            $(this).parent().parent().remove();
        });

        //为编辑tab页增加事件处理函数
        $("#id_tab_edit_wbs").on("click", load_node_to_edit);
        $("#id_tab_add_wbs").on("click", function(){
            $("#id_panel_wbs_edit").hide();
            $("#id_panel_wbs_add").show();
        });
    });


    /**
     * jq函数
     * */

     jQuery(function($){

        /*文件上传组件*/
        /*
        $('#id-input-file-1 , #id-input-file-2').ace_file_input({
         no_file:'没有选择文件 ...',
         btn_choose:'选择文件',
         btn_change:'重新选择',
         droppable:false,
         onchange:null,
         thumbnail:false //| true | large
         //whitelist:'gif|png|jpg|jpeg'
         //blacklist:'exe|php'
         //onchange:''
         //
         });*/

        $('#input-file').ace_file_input({
            style:'well',
            btn_choose:'点击选择文件或将文件拖放至该区域',
            btn_change:null,
            no_icon:'fa fa-cloud-upload',
            droppable:true,
            thumbnail:'small'//large | fit
            //,icon_remove:null//set null, to hide remove/reset button
            /**,before_change:function(files, dropped) {
						//Check an example below
						//or examples/file-upload.html
						return true;
					}*/
            /**,before_remove : function() {
						return true;
					}*/
            ,
            preview_error : function(filename, error_code) {
                //name of the file that failed
                //error_code values
                //1 = 'FILE_LOAD_FAILED',
                //2 = 'IMAGE_LOAD_FAILED',
                //3 = 'THUMBNAIL_FAILED'
                //alert(error_code);
            }

        }).on('change', function(){
            //console.log($(this).data('ace_input_files'));
            //console.log($(this).data('ace_input_method'));
        });


        //dynamically change allowed formats by changing before_change callback function
        $('#id-file-format').removeAttr('checked').on('change', function() {
            var before_change
            var btn_choose
            var no_icon
            if(this.checked) {
                btn_choose = "点击选择图片或将图片拖放至该区域";
                no_icon = "fa fa-image";
                before_change = function(files, dropped) {
                    var allowed_files = [];
                    for(var i = 0 ; i < files.length; i++) {
                        var file = files[i];
                        if(typeof file === "string") {
                            //IE8 and browsers that don't support File Object
                            if(! (/\.(jpe?g|png|gif|bmp)$/i).test(file) ) return false;
                        }
                        else {
                            var type = $.trim(file.type);
                            if( ( type.length > 0 && ! (/^image\/(jpe?g|png|gif|bmp)$/i).test(type) )
                                    || ( type.length == 0 && ! (/\.(jpe?g|png|gif|bmp)$/i).test(file.name) )//for android's default browser which gives an empty string for file.type
                            ) continue;//not an image so don't keep this file
                        }

                        allowed_files.push(file);
                    }
                    if(allowed_files.length == 0) return false;

                    return allowed_files;
                }
            }
            else {
                btn_choose = "点击选择文件或将文件拖放至该区域";
                no_icon = "fa fa-cloud-upload";
                before_change = function(files, dropped) {
                    return files;
                }
            }
            var file_input = $('#input-file');
            file_input.ace_file_input('update_settings', {'before_change':before_change, 'btn_choose': btn_choose, 'no_icon':no_icon})
            file_input.ace_file_input('reset_input');
        });


        /** spinner组件
         * 需引用fuelex的js脚本
         */
        $('#id_working_day_spinner')
                .ace_spinner({value:0,min:0,max:999,step:1, btn_up_class:'btn-info' , btn_down_class:'btn-info'})
                .on('change', function(){
                    calc_working_hour();
                });

        $("#id_working_hour_spinner")
                .ace_spinner({value:8,min:1,max:999,step:0.5, btn_up_class:'btn-info' , btn_down_class:'btn-info'})
                .on('change', function(){
                    calc_working_hour();
                });

        /**
         * 日期选择组件
         */
        $('#id_date_picker_start').datepicker({ autoclose: true, todayHighlight: true })
                .on('changeDate', function(e){
                    var end = $("#id_date_picker_end").val();
                    if(end.length > 1){
                        var end_date = new Date(end);
                        check_date(e.date, end_date);
                    }
                })
                .next().click(function(){ $(this).prev().focus(); });

        $('#id_date_picker_end').datepicker({ autoclose: true, todayHighlight: true })
                .on('changeDate', function(e){
                    var end = $("#id_date_picker_start").val();
                    if(end.length > 1){
                        var end_date = new Date(end);
                        check_date(end_date, e.date);
                    }
                })
                .next().click(function(){ $(this).prev().focus(); });

    });




</script>